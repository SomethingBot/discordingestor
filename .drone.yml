kind: pipeline
type: docker
name: build

trigger:
  event:
    - push
    - tag
    - pull_request

steps:
  - name: fmt and tidy
    image: golang:1.18
    commands:
      - test -z $(go fmt ./...)
      - go mod tidy
      - git diff --exit-code -- go.mod go.sum
      - git diff --exit-code -- go.mod go.sum > test -z
  - name: build and vet
    image: golang:1.18
    commands:
      - go build .
      - go vet -race -v ./...
  - name: test
    image: golang:1.18
    commands:
      - go test -v ./... -short
---
kind: pipeline
type: docker
name: test

trigger:
  event:
    - push
    - tag

depends_on:
  - build

steps:
  - name: test-integration
    image: golang:1.18
    commands:
      - go test -v ./...
    environment:
      discordapikey:
        from_secret: discordapikey
---
kind: pipeline
type: docker
name: tagged version in libinfo

trigger:
  event:
    - push

#depends_on:
#  - build

steps:
  - name: check version is HEAD
    image: golang:1.18
    commands:
      - echo "ZWNobyBDdXJyZW50IGxhdGVzdCB0YWcgaXMgJChnaXQgdGFnIC0tc29ydD1jb21taXR0ZXJkYXRlIHwgdGFpbCAtMSkgSEVBRCBpcyAkKGdpdCB0YWcgLS1wb2ludHMtYXQgSEVBRCkKZWNobyBDdXJyZW50IHRhZyBpbiBkaXNjb3JkL2xpYmluZm8vaW5mby5nbyBpcyAkKGdyZXAgIkJvdExpYnJhcnlWZXJzaW9uID0iIGRpc2NvcmQvbGliaW5mby9pbmZvLmdvIHwgYXdrICd7cHJpbnQgc3Vic3RyKCQzLCAyLCBsZW5ndGgoJDMpLTIpfScpCnRlc3QgJChncmVwICJCb3RMaWJyYXJ5VmVyc2lvbiA9IiBkaXNjb3JkL2xpYmluZm8vaW5mby5nbyB8IGF3ayAne3ByaW50IHN1YnN0cigkMywgMiwgbGVuZ3RoKCQzKS0yKX0nKSA9ICQoZ2l0IHRhZyAtLXNvcnQ9Y29tbWl0dGVyZGF0ZSB8IHRhaWwgLTEgfCBhd2sgJ3twcmludCBzdWJzdHIoJDAsMiwgbGVuZ3RoKCQwKSl9JykK" | base64 -d | sh
#//above is just checking, but in base64 to prevent drone from messing with variables